### 浏览器输入URL回车后，会发生什么？

#### 一、解析URL

​	回车键按下，操作系统给浏览器一个“回车按下”事件，浏览器开始解析URL。通过URL，浏览器可以知道以下信息：

1. 传输协议（如http或https）
2. 服务器域名（或者IP地址）
3. 端口号（如80）
4. 请求资源页
5. 查询参数

如果协议或者域名不合法，浏览器会当作关键字搜索，将它交给默认的搜索引擎，反之这是一个正常的URL，可以跳转

#### 二、DNS查询

​	得到URL后，浏览器首先查找域名是不是在自己的缓存中，如果缓存没有，就会查询本地的host文件，如果还是没有找到，它会向DNS服务器发送一条DNS查询请求，并返回目标服务器的IP地址。

​	DNS域名解析基本过程如下：首先向本地DNS服务器发出查询请求，如果本地服务器缓存中没有，本地DNS服务器就联系DNS根服务器，根服务器会给出对应域服务器的地址，让本地DNS服务器向域服务器查询，如果域服务器可以给出IP就返回，否则给出下一个域服务器地址让本地DNS服务器继续查询。最后本地DNS服务器向网络客户端返回IP地址，并将其写入缓存。

#### 三、TCP连接

​	当浏览器得到了目标服务器的IP地址，以及URL中给出的端口号，它会调用系统库函数socket，请求一个TCP流套接字，对应的参数是AF_INET/AF_INET6和SOCK_STREAM。

​	这个请求会交给传输层，在传输层请求会被封装成TCP segment。目标端口会被加入头部，源端口号会在系统内核的动态端口范围内选取。

​	TCP segment被送往网络层，网络层会在其中再加入一个IP头部，里面包含目标服务器的IP地址和本机的IP地址，把它封装成一个IP pocket。

​	这个IP pocket接下类被送往数据链路层，链路层会在封包中装入frame头部，里面包含了本地内置网卡的MAC地址和网关（本地路由器）的MAC地址。

​	接下来就是连接和发送：

##### 三次握手

![三次握手](F:\mycode\knowledgeArrangement\计算机网络\three_hands.png)

- 客户端选择一个初始序列号（ISN），将设置了SYN位的封包发送给服务器端，表明自己要建立连接。
- 服务端受到封包，如果可以建立连接，那么服务端将选择自己的初始序列号，设置SYN位，然后设置ACK位，将客户端ISN+1复制到ack域，表明自己收到了客户端的第一个封包。
- 客户端发送下面这个封包来确认这次连接：自己的序列号+1,设置ACK位，将ack域置为服务端ISN+1

##### 发送数据包

当一方发送了N个数据包后，将自己的SEQ序列号也增加N；另一方确认接收到这个数据包（或者一系列数据包）之后，它发送一个ACK包，ACK设置为接收到的数据包的最后一个序号。

##### 四次握手

![四次握手](F:\mycode\knowledgeArrangement\计算机网络\four_hands.jpg)

要关闭连接的一方Client发送一个FIN 包，表示自己的数据已经发送完了；Server发送ACK包确认这个FIN包，但此时可能并不会关闭；Server确认数据发送完毕，发送一个FIN包，表示自己的数据发送结束，Client发送ACK包确认。

#### 四、TLS握手

- 客户端发送ClientHello消息到服务器端，消息中包含了它的TLS(Transport Layer Security)版本，可用的加密算法和压缩算法。
- 服务器端向客户端返回一个ServerHello消息，包含了服务器端的TLS版本，服务器选择的加密和压缩算法，以及数字证书认证机构（CA）签发的服务器公开证书，证书中包含了公钥。客户端用这个公钥加密接下来的握手过程，直到协商生成一个新的对称密钥。
- 客户端根据自己的信任CA列表，验证服务器的证书是否可信。如果可信，客户端将生成一串伪随机数，使用服务器给的公钥加密它。这串随机数会被用于生成新的对称密钥。然后客户端将这串加密后的伪随机数发送给服务器端。
- 服务器端使用自己的私钥解密收到的随机数，然后用这串随机数生成自己的对称主密钥
- 客户端发送一个Finished消息给服务器端，使用对称密钥加密这次通讯的一个散列值
- 服务器生成自己的hash值，然后解密客户端发送来的值，检查这两个值是否对应。如果对应，就像客户端发送一个Finished消息，也是用协商好的对称密钥加密
- 从现在开始，接下来真整个TLS会话都使用对称密钥进行加密，传输应用层（HTTP）内容

#### 五、HTTP请求

tcp建立连接后，浏览器发送请求报文，http请求报文分为三块：

请求行：请求方法（GET、POST、PUT、DELETE等），协议版本，url地址

请求头：包括一些浏览器的设置和内容缓存信息

请求体：和请求头直接隔一个空行，这个空行表示请求头的结束，下面是请求体内容，包含一些要查询的信息等。



服务端的响应报文和请求报文一样分为三个部分：

响应行： 协议版本呢，状态码，状态原因

状态码：

- 1xx：指示信息-请求已接收，继续处理
- 2xx：成功-表示请求已被成功接收、理解、接受
- 3xx：重定向
- 4xx：客户端错误-请求有错误或无法实现
- 5xx：服务器端错误-服务器未能实现合法的请求

响应头：包含一些连接信息

响应体：包含返回给浏览器的文本信息

#### 六、浏览器渲染页面

略

