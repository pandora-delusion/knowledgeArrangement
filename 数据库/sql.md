#### MySQL外键约束On Delete和On Update的使用

设置外键的格式：

```mysql
ALTER TABLE t_employee_task ADD CONSTRAINT FK_Reference_4 FOREIGN KEY (emp_id) REFERENCES t_employee (id) [ON DELETE RESTRICT ON UPDATE RESTRICT];
```

On Delete和On Update都有Restrict，No Action，Cascade，Set Null属性

- ON DELETE

**restrict（约束）**：当在父表（即外键的来源表）中删除对应的记录时，首先检查该记录是否有对应外键，如果有则不允许删除。

**no action**：意思同restrict

**cascade（级联）**：当在父表中删除对应的记录时，首先检查记录是否有对应外键，如果有则也删除外键在子表（即包含外键的表）中的记录。

**set null**：当在父表中删除对应记录时，首先检查记录是否有对应外键，如果有则设置子表中该外键值为null（这就要求该外键允许为null)

- ON UPDATE

**restrict（约束）**：当在父表中更新对应记录时，首先检查该记录是否有对应外键，如果有则不允许更新。

**no action**：同restrict

**cascade（级联）**：当在父类中更新对应记录时，首先检查该记录是否有对应的外键，如果有也更新外键在子表（即包含外键的表）中的记录

**set null**：当在父表中更新对应记录时，首先检查该记录是否有对应外键，如果有则设置子表中该外键值为null

注：NO ACTION和RESTRICT的区别：只有在极个别的情况下会导致区别，前者是在其他约束的动作之后执行，后者具有最高的优先权执行。

#### 数据库事务隔离级别

任何支持事务的数据库，都必须具备四个特性，分别是：

原子性（Atomicity），一致性（Consistency），隔离性（Isolation），持久性（Durability）

原子性：整个事务的所有操作，要么全部完成，要么全部不完成，不可能停滞在中间某个环节。事务在执行过程中发生错误，会回滚到事务开始前的状态。

一致性：指一个事务可以改变封装状态（除非它是一个只读的）。事务必须始终保持系统处于一致的状态， 不管在任何给定的时间并发事务有多少。

隔离性：它是指两个事务之间的隔离程度

持久性：事务完成后，该事务对数据库所作的更改持久保存在数据库中。

也就是我们常说的ACID

事务的隔离性是指，多个并发的事务同时访问一个数据库时，一个事务不应该被另一个事务所干扰，每个并发的事务间要相互进行隔离。如果没有事务隔离，会出现集中情况：

- **脏读**：一个事务读到了另一个事务未提交而插入的数据
- **不可重复读**：一个事务相同情况的两次读取的数据不同
- **幻读**：一个事务对部分（或全部）数据修改时，另一个事务也进行了修改（比如插入了一行新数据），使得第一个事务发现表中还有没有修改的数据，就像发生了幻觉一样

为了防止以上情况，需要设置数据库隔离级别，一般有四种隔离级别：

- 读未提交（脏读）：就是可以读到未提交的内容，一致性最差，可能会产生上述惨重问题

- 读提交：只能读到已经提交了的内容,是各种系统中最常用的一种隔离级别，也是SQL Server和Oracle的默认隔离级别。这种隔离级别能够有效的避免脏读。但除非在查询中显式的加锁，普通的查询是不会加锁的。

  相对于读未提交，读提交避免脏读的机制是“快照（snapshot）”，这种既能保证一致性又不加锁的读称为快照读。假设没有“快照读”，那么当一个更新的事务没有提交时，另一个对更新数据进行查询的事务会因为无法查询而被阻塞，这种情况下，并发能力就相当的差。而“快照读”就可以完成高并发的查询，不过，“读提交”只能避免“脏读”，并不能避免“不可重复读”和“幻读”。

- 可重复读：专门针对“不可重复读”这种情况而制定的隔离级别，是MySql的默认隔离级别（针对数据库同一条记录而言的）

  在这个级别下，普通的查询同样是使用的“快照读”，但是，和“读提交”不同的是，当事务启动时，就不允许进行“修改操作（Update）”了，而“不可重复读”恰恰是因为两次读取之间进行了数据的修改，因此，“可重复读”能够有效的避免“不可重复读”，但却避免不了“幻读”，因为幻读是由于“插入或者删除操作（Insert or Delete）”而产生的。

- 串行化

  这是数据库最高的隔离级别，这种级别下，事务“串行化顺序执行”，也就是一个一个排队执行。

  这种级别下，“脏读”、“不可重复读”、“幻读”都可以被避免，但是执行效率奇差，性能开销也最大，所以基本没人会用。